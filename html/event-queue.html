<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />

<title>Game Programming Patterns / Decoupling Patterns / Event Queue</title>

<!-- Tell mobile browsers we're optimized for them and they don't need to crop
     the viewport. -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<link rel="stylesheet" type="text/css" href="style.css" />
<link href="http://fonts.googleapis.com/css?family=Source+Code+Pro|Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42804721-1', 'gameprogrammingpatterns.com');
  ga('send', 'pageview');
</script>
</head>
<body id="top">
<div class="content">
<div class="in-progress">
  <span class="dismiss">&times;</span>
  <p><strong>This book is a work in progress!</strong></p>

  <p>If you see a mistake, find something unclear, or have a suggestion, please <a href="https://github.com/munificent/game-programming-patterns/issues" target="_blank">file a ticket</a>. To know when new chapters are up, join the mailing list:</p>

  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="http://gameprogrammingpatterns.us7.list-manage.com/subscribe/post?u=0952ca43ed2536d6717766b88&amp;id=0c27329244" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <table>
      <tr>
        <td width="100%">
          <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        </td>
        <td>
          <div class="spacer"></div>
        </td>
        <td>
          <input type="submit" value="Join" name="subscribe" id="mc-embedded-subscribe" class="button">
        </td>
      </tr>
    </table>
  </form>
  </div>
  <!--End mc_embed_signup-->

  <table width="100%">
    <tr>
      <td width="50%">
        <p>Thank you!</p>
      </td>
      <td width="50%">
        <p class="signature">&mdash; Bob (<a href="https://twitter.com/intent/user?screen_name=munificentbob" target="_blank">@munificentbob</a>)</p>
      </td>
    </tr>
  </table>
</div>
<h1>Event Queue</h1>
<h1 class="book"><a href="index.html">Game Programming Patterns</a> / <a href="decoupling-patterns.html">Decoupling Patterns</a></h1>
<h2><a href="#intent" name="intent">Intent</a></h2>
<p><em>Buffer messages or events to decouple the sender from when and how it is processed.</em></p>
<h2><a href="#motivation" name="motivation">Motivation</a></h2>
<ul>
<li>pattern can be used to solve a bunch of similar but not identical problems</li>
<li>to get most of out chapter, use example that jams all problems together</li>
<li>then we&#x2019;ll knock em down one after another</li>
<li>in reality, of course, won&#x2019;t be such perfect fit</li>
<li>this way can see lots of facets of pattern</li>
</ul>
<p><strong>todo: can fit discussion of event/message/command here? mention global event queue</strong></p>
<h3><a href="#say-what" name="say-what">Say what?</a></h3>
<ul>
<li>working on adding audio to game</li>
<li>often overlooked facet of game dev</li>
<li>humans are primarily visual but sound is deeply keyed to our emotions and sense of physical space</li>
<li>
<p>good sound can make you feel surrounded by the game and make heartstrings ring with every action the hero takes</p>
</li>
<li>
<p>lots of things trigger sounds: collisions in physics engine, using items, gameplay events like leveling up, level events like opening door, npc ai yelling at you, and hero herself</p>
</li>
<li>start with simple approach</li>
<li>have little "audio engine" in game</li>
<li>it has api for playing a sound given id and volume
  (3d sound would have more complex api)</li>
<li>
<p>knows how to find appropriate sound file and throw it at hardware to make it
  play</p>
</li>
<li>
<p>start sprinkling call throughout codebase</p>
</li>
<li>in physics code, when objects collide trigger sound</li>
<li>run into first problem: audio api takes a little while to locate sound
  resource and copy buffer of data to somewhere hardware can play it</li>
<li>
<p>since api is synchronous, that blocks the physics engine!</p>
</li>
<li>
<p><strong>problem 1: requesting a sound to play blocks the caller until the audio
  engine has started playing the sound</strong></p>
</li>
<li>
<p>ignoring that for now, we move on. in code for monster, trigger "oof" when
  takes damage from hero</p>
</li>
<li>
<p>works pretty well, but occasional problem</p>
</li>
<li>can sometimes hit two monsters in exact same frame</li>
<li>when that happens, plays sound twice at <em>exact</em> same time</li>
<li>if you know anything about audio, knows that basically stacks the waveforms</li>
<li>do that with the <em>same</em> waveform and it&#x2019;s just like multiplying it</li>
<li>in other words, sounds like <em>one</em> "oof" sound played twice as long</li>
<li>sounds jarring and wrong</li>
<li>
<p>[ran into exact problem in hatsworth]</p>
</li>
<li>
<p><strong>problem 2: redundant requests are handled individual and behave wrongly since they are unaware of each other</strong></p>
</li>
<li>
<p>things get worse in big boss fights with lots of enemies and action going on</p>
</li>
<li>hardware can only play so many sounds at one time</li>
<li>if try to play too many sounds at once, some get dropped or cut off</li>
<li>sounds designers anticipated this by recording some "multi sounds"</li>
<li>so, if have bunch of small explosions around same time, instead of using a bunch of channels on them, can use a single channel to play one "big bang" sound</li>
<li>but need to know that we&#x2019;re playing a bunch of small sounds at once</li>
<li>
<p>since audio just gets individual api calls, can&#x2019;t look at them in aggregate</p>
</li>
<li>
<p><strong>problem 3: can&#x2019;t analyze, group, and process a series of requests at once</strong></p>
</li>
<li>
<p>now let&#x2019;s get to real nasty problem</p>
</li>
<li>got lots of calls to audio api in game now, coming from lots of different
  systems</li>
<li>scary part is many of those systems running on different threads!</li>
<li>since audio api is sync, code runs on <em>caller&#x2019;s</em> thread</li>
<li>if gameplay thread triggers sound at same time as physics thread, all hell
  breaks loose</li>
<li>or have to do careful sync, which slows down both threads</li>
<li>and (as typical) want audio to be on its <em>own</em> thread</li>
</ul>
<h3><a href="#leave-a-message" name="leave-a-message">Leave a message</a></h3>
<ul>
<li>common thread in these problems is that audio api we expose means play sound
  <em>right now</em></li>
<li>the right-now-ness is the problem</li>
<li>point in time that caller requests a sound is time that&#x2019;s convenient for
  <em>caller</em>, not audio engine</li>
<li>
<p>to solve, decouple when we request sound be played and when audio engine
  actually plays it</p>
</li>
<li>
<p>simplest way to do that would be to have a slot in audio engine for "requested sound"</p>
</li>
<li>calling api just stores sound id in that slot and returns</li>
<li>later, when audio engine is updated by game loop, checks slot and starts sound</li>
<li>problem is that if you make <em>two</em> audio calls before engine processes first,
  slot is already full</li>
<li>want a bunch of slots</li>
<li>calling api will fill next available one</li>
<li>updating audio engine walks them in the order they were filled so oldest
  request is handled first</li>
<li>that&#x2019;s a queue!</li>
</ul>
<h2><a href="#the-pattern" name="the-pattern">The Pattern</a></h2>
<p>A <strong>queue</strong> stores a series of <strong>notifications or requests</strong> in last-in, first-out order. Sending a notification simply <strong>enqueues the request and returns</strong>. The request processor then <strong>processes items from the queue later</strong> at an appropriate time.</p>
<p>Requests can be <strong>handled directly</strong>, or <strong>routed to interested parties</strong>. This <strong>decouples the sender from the receiever</strong> both <strong>statically</strong> and <strong>in time</strong>.</p>
<h2><a href="#when-to-use-it" name="when-to-use-it">When to Use It</a></h2>
<ul>
<li>queueing is useful when you have stream of stuff coming in&thinsp;&mdash;&thinsp;events, request
  notifications</li>
<li>want to isolate source of requests from object or objects that will be
  responding to or processing them</li>
<li>lots of patterns decouple stuff like that: observer and command are two
  similar ones</li>
<li>difference here is queue decouples sender/receiver <em>temporally</em></li>
<li>
<p>sender not only doesn&#x2019;t know who will respond, doesn&#x2019;t know when</p>
</li>
<li>
<p>gives responder more control and context over handling stuff</p>
</li>
<li>can see entire list of things to respond</li>
<li>can respond at appropriate time in game loop, or on different thread</li>
<li>
<p>sender sacrifices control</p>
</li>
<li>
<p>good bit more complex than other solutions</p>
</li>
<li>queue takes memory</li>
<li>have to make sure gets processed in timely manner</li>
<li>normally i start with something simpler and sync like observer and then go
  to queue when know i need it</li>
<li>
<p>"need it" usually means sending event or message is causing problems for
  sender</p>
</li>
<li>
<p>this is probably obvious, but queues are poor fit when sender needs response</p>
</li>
<li>fire and forget</li>
<li>sometimes see async responses too: send async event, handler sends async
  response</li>
<li>then original sender processes it</li>
<li>works <em>sometimes</em> but sketchy. original sender may have changed state or not
  be in good place to handle response by time it gets it</li>
<li>do you really want effective complexity of networking code <em>inside</em> game
  engine?</li>
</ul>
<h2><a href="#keep-in-mind" name="keep-in-mind">Keep in Mind</a></h2>
<h3><a href="#global-queue-is-still-global" name="global-queue-is-still-global">global queue is still global</a></h3>
<ul>
<li>many games have global event queue for sharing high-level events with any
  system that wants them</li>
<li>useful for broadcasting events to any system that wants them</li>
<li>lets high-level parts of codebase interact without coupling</li>
<li>think playing sounds based on physics</li>
<li>
<p>showing tutorial hints as player progresses through level, etc.</p>
</li>
<li>
<p>but global is still bad</p>
</li>
<li>global queue has same problems as other globals</li>
<li>big mutable blog of data anything in game can write to (send event) and
  read to (receive event)</li>
</ul>
<h3><a href="#state-of-world-may-have-changed-between-senderreceiver" name="state-of-world-may-have-changed-between-senderreceiver">state of world may have changed between sender/receiver</a></h3>
<ul>
<li>say using above global queue</li>
<li>say game entity sends "died" event when dies</li>
<li>now say achievement system wants to monitor that to see if you kill certain
  number of some kind of entity</li>
<li>with synchronous event system, even can just be simple event enum</li>
<li>event receiver can then go inspec world to see what happened</li>
<li>
<p>so achievement system gets died event, looks to see which entity in world has
  zero hp, etc.</p>
</li>
<li>
<p>now consider queued event</p>
</li>
<li>dying entity enqueues "die" event</li>
<li>at end of frame, entity is removed from world</li>
<li>next frame, go to process queue</li>
<li>achievement system sees died event, but can no longer find entity</li>
<li>since don&#x2019;t know when event will be handled, can&#x2019;t rely on state of world
  being same between when sent and when handled</li>
<li>means event/message objects themselves larger and more self-contained</li>
<li>with sync events, it&#x2019;s basically "something happened, look at world to figure
  out what"</li>
<li>with queued, it&#x2019;s "here&#x2019;s exactly what happened"</li>
</ul>
<h3><a href="#lifecycle-of-eventmessage-object" name="lifecycle-of-eventmessage-object">lifecycle of event/message object</a></h3>
<ul>
<li>with sync notification, event itself can be just couple of parameters to
  fn, or object on stack</li>
<li>since done with it by time sending message is done, lifetime is easy</li>
<li>
<p>since queue decouples when event is handled, event object needs to live longer
  than call to send it</p>
</li>
<li>
<p>not particularly hard, but important to remember</p>
</li>
<li>discuss options below</li>
</ul>
<h3><a href="#feedback-cycles" name="feedback-cycles">feedback cycles</a></h3>
<ul>
<li>all event systems have to worry about cycles:</li>
<li>sender sends event, receiver responds to it by sending event which is in turn
  handled by original sender</li>
<li>if not careful, can get stuck in loop</li>
<li>with sync system, will quickly overflow stack and crash</li>
<li>
<p>easy bug to notice and fix</p>
</li>
<li>
<p>queues won&#x2019;t crash, which is "better"</p>
</li>
<li>can actually support feedback loops correctly</li>
<li>but often don&#x2019;t want feedback loop</li>
<li>even if handled safely, not usually what you&#x2019;re trying to express</li>
<li>keep eye on events and make sure don&#x2019;t see same series of them bouncing
  around</li>
<li>good guideline is to avoid sending events in code that is responding to one</li>
</ul>
<h2><a href="#sample-code" name="sample-code">Sample Code</a></h2>
<p><strong>Bunch of paragraphs, maybe some subheaders</strong></p>
<h2><a href="#design-decisions" name="design-decisions">Design Decisions</a></h2>
<p>**Few subheader questions, bullet list of answers for each</p>
<h2><a href="#see-also" name="see-also">See Also</a></h2>
<ul>
<li>
<p>if want something lighter-weight and faster, observer is close cousin</p>
</li>
<li>
<p>commands often queued</p>
</li>
<li>
<p>finite state machines often respond to stream of inputs</p>
</li>
<li>if don&#x2019;t want them to respond synchronously, can give fsm queue to handle
  them. often call &#x2019;mailbox&#x2019;</li>
<li>state chapter has more on fsms</li>
<li>when have bunch of fsms with mailboxes sending messages to each other, have
  re-invented actor model</li>
<li>
<p>[erlang language based on this]</p>
</li>
<li>
<p>like many patterns, often has a lot of names:</p>
</li>
<li>
<p>"message queue" is established term for same pattern</p>
</li>
<li>usually used to talk about messaging at higher level between applications
    and not as much within them</li>
<li>
<p>lots of middleware for this: zeromq, rabbitmq, etc. if see "mq" in name
    now know what stands for</p>
</li>
<li>
<p>"publish/subscribe"</p>
</li>
<li>very similar model</li>
<li>usually used to describe behavior of distributed systems, and not within
    single application</li>
</ul>
<hr />
<p>random notes:</p>
<ul>
<li>
<p>dovetails really nicely with fsms, which want to receive stream of events</p>
</li>
<li>
<p>1-many, many-1, and many-to-many queues</p>
</li>
<li>1-many: broadcast events. like observer pattern<ul>
<li>more likely to use "events"</li>
</ul>
</li>
<li>many-1: sink. think audio engine where anything can tell it to play a sound
    and it has one internal queue is uses to process those requests<ul>
<li>more likely to use "messages"</li>
</ul>
</li>
<li>
<p>many-many: like global event bus. anything can announce something
    interesting. anything can receive it. filtering becomes much more important.</p>
<ul>
<li>see also blackboards</li>
</ul>
</li>
<li>
<p>talk about threading</p>
</li>
<li>with observer, message receiver always runs on <em>sender&#x2019;s</em> thread</li>
<li>with queue, can hop threads so receiver runs on thread it expects to run on</li>
<li>with a global event queue, that means objects listening to queue can end up
  with infinite lifetime if not explicitly unregistered. talk about memory
  leak</li>
<li>event priority to handle too many queued events</li>
<li>talk about ordering. is it a strict queue or can things be delivered out of
  order? how does threading affect that?</li>
<li>relate to job systems and worker threads?</li>
<li>relate to event-based programming</li>
<li>game loop is sort of like event loop where "event" is a tick</li>
<li>some simple games can actually use os event loop for game loop by updating
    game on "idle" events. not precise enough for real-time games</li>
<li>
<p>sample code should walk through ring buffer</p>
</li>
<li>
<p>channels in go</p>
</li>
<li>talk a bit about message queues as middleware in business apps: zeromq, etc.</li>
<li>queueing is helpful for networking.</li>
<li>gives meaningful serializable thing to send to server</li>
<li>
<p>see command pattern</p>
</li>
<li>
<p>talk about how user input is usually queue</p>
</li>
<li>link to game loop which discusses pulling input versus push</li>
<li>
<p>also talk about in general about when to pull events off queues and how that
    ties to game loop</p>
</li>
<li>
<p>have to think about what event/message represents. is it notice that thing
  happened, or request for thing to happen?</p>
</li>
<li>for example, do we sent "object collided" event and wait for audio engine
    to receive that and play sound, or do we sent "play collision sound"
    message?</li>
<li>depends on sender and intended receiver</li>
<li>if queue is global, event is usually what happened</li>
<li>if queue is specific to obj or system, usually message: request for action</li>
<li>if sender and intended receiver are in different domains (physics and audio)
    then usually event. if in same domain (audio component of actor and audio
    engine) to be command or message</li>
</ul>
<p>http://www.gamedev.net/topic/136778-event-queue-and-events-in-games/
http://gamedev.stackexchange.com/questions/14383/best-way-to-manage-in-game-events
http://gamedev.stackexchange.com/questions/7718/event-driven-communication-in-game-engine-yes-or-no?rq=1</p>
</div>
<p class="footer">&copy; 2009-2013 Bob Nystrom</p>
</body>
<script src="jquery-1.10.1.min.js"></script>
<script src="script.js"></script>
</html>
